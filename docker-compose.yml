version: 3.8

services:
  backend:
    build : .
    container_name : ace_backend
    command : uv run python -m main
    ports:
    - "${BACKEND_PORT:-8000}:8000"
    environment:
      - REDIS_HOST=redis
      - QDRANT_HOST=qdrant
      - BACKEND_PORT=8000
      - BACKEND_URL=http://backend:8000
    volumes:
      - .:/app
      - ./db:/app/db
      - ./logs:/app/logs
    
    deploy:
      resources:
        reservations:
          - driver : nvidia
            count : all
            capabilities : [gpu]
            
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/docs"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    
    depends_on:
      - redis
      - qdrant

  frontend:
    build: .
    container_name : ace_frontend
    command: uv run streamlit run web/app.py --server.port=8501 --server.address=0.0.0.0
    ports:
      - "8501:8501"
    environment:
      - BACKEND_URL=http://backend:8000
    volumes:
      - .:/app
  
  redis:
    image : redis:alpine
    container_name : ace_redis
    command : redis-server --appendonly yes
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - ./redis_data:/data
  
  qdrant:
    image : qdrant/qdrant
    container_name : ace_qdrant
    ports:
      - "6333:6333"
    volumes:
      - ./qdrant_data:/qdrant
